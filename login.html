<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Bazar - Authenticate</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --p-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --p-glow: 0 0 20px rgba(99, 102, 241, 0.4);
            --bg: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --text-h: #0f172a;
            --text-p: #64748b;
            --accent: #10b981;
            --danger: #f43f5e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-h); line-height: 1.6; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }

        .elite-card {
            background: var(--glass); backdrop-filter: blur(20px); border-radius: 22px; padding: 25px;
            width: 100%; max-width: 400px; border: 1px solid rgba(255,255,255,0.7);
            box-shadow: 0 8px 30px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn-elite {
            width: 100%; padding: 14px; border: none; border-radius: 16px;
            background: var(--p-gradient); color: white; font-size: 0.95rem; font-weight: 700;
            cursor: pointer; transition: 0.3s; box-shadow: var(--p-glow);
            margin-top: 10px;
        }
        .btn-elite:active { transform: scale(0.97); }
        .btn-ghost { background: #f1f5f9; color: var(--text-p); box-shadow: none; margin-top: 15px; }

        .input-group { margin-bottom: 14px; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 800; color: var(--text-p); margin-bottom: 5px; margin-left: 5px; }
        .input-group input {
            width: 100%; padding: 14px 18px; background: #fff; border: 1.5px solid #e2e8f0;
            border-radius: 15px; outline: none; transition: 0.3s; font-size: 0.9rem;
        }
        .input-group input:focus { border-color: #6366f1; }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 600; display: none; z-index: 3000;
        }

        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

<div id="toast">Message</div>

<!-- Login/Signup View -->
<div id="auth-view" class="view active">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 2.5rem; font-weight: 800; background: var(--p-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">TaskBazar</h1>
        <p id="tagline" style="color: var(--text-p); font-weight: 600; font-size: 0.9rem;">The Premium Micro-Task Platform</p>
    </div>
    
    <div class="elite-card">
        <div id="auth-fields">
            <div class="input-group" id="name-box" style="display: none;">
                <label>‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="reg-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            <div class="input-group" id="refer-box" style="display: none;">
                <label>‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                <input type="text" id="reg-refer" placeholder="‡¶ï‡ßã‡¶° ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¶‡¶ø‡¶®">
            </div>
            <div class="input-group">
                <label>‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏</label>
                <input type="email" id="auth-email" placeholder="email@example.com">
            </div>
            <div class="input-group">
                <label>‡¶ó‡ßã‡¶™‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</label>
                <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn-elite" id="main-auth-btn" onclick="handleAuthAction()">Login</button>
            
            <!-- ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶® ‡¶¨‡¶æ‡¶ü‡¶® -->
            <div id="forgot-pass-box" style="text-align: center; margin-top: 15px;">
                <span onclick="resetPassword()" style="font-size: 0.75rem; color: #64748b; font-weight: 800; cursor: pointer; transition: 0.3s;">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®?</span>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; border-top: 1px solid #f1f5f9; padding-top: 15px;">
            <p id="toggle-msg" style="font-size: 0.8rem; color: var(--text-p); font-weight: 600;">
                New to the community? <span id="toggle-link" onclick="toggleAuthMode(true)" style="color: #6366f1; font-weight: 800; cursor: pointer;">Register Now</span>
            </p>
        </div>
    </div>
</div>

<!-- Email Verification View -->
<div id="verify-view" class="view">
    <div class="elite-card" style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 20px;">üìß</div>
        <h2 style="font-weight: 800; margin-bottom: 10px;">‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        <p style="font-size: 0.9rem; color: var(--text-p); margin-bottom: 25px;">‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        <button class="btn-elite" onclick="reloadUser()">Check Status</button>
        <button class="btn-elite btn-ghost" onclick="resendVerification()">‡¶∞‡¶ø‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï</button>
        <button class="btn-elite btn-ghost" onclick="firebase.auth().signOut().then(()=>location.reload())" style="color: var(--danger);">Logout</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
        authDomain: "exchange-project-d4028.firebaseapp.com",
        databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exchange-project-d4028",
        storageBucket: "exchange-project-d4028.firebasestorage.app",
        messagingSenderId: "313976742479",
        appId: "1:313976742479:web:45951b360d875c4768c03a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const appId = "exchange-project-d4028";

    let isSignupMode = false;

    function showToast(msg) { 
        const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; 
        setTimeout(() => t.style.display = 'none', 3000); 
    }

    // ‡¶≤‡¶ó‡¶á‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™ ‡¶Æ‡ßÅ‡¶° ‡¶ü‡¶ó‡¶≤
    function toggleAuthMode(isSignup) {
        isSignupMode = isSignup;
        document.getElementById('name-box').style.display = isSignup ? 'block' : 'none';
        document.getElementById('refer-box').style.display = isSignup ? 'block' : 'none';
        
        // ‡¶∏‡¶æ‡¶á‡¶®‡¶Ü‡¶™ ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßü "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®" ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        document.getElementById('forgot-pass-box').style.display = isSignup ? 'none' : 'block';
        
        document.getElementById('main-auth-btn').innerText = isSignup ? "Create Account" : "Login";
        document.getElementById('toggle-msg').innerHTML = isSignup ? 
            `Already a member? <span onclick="toggleAuthMode(false)" style="color:#6366f1; font-weight:800; cursor:pointer;">Login Now</span>` : 
            `New to the community? <span onclick="toggleAuthMode(true)" style="color:#6366f1; font-weight:800; cursor:pointer;">Register Now</span>`;
    }

    // ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    async function resetPassword() {
        const email = document.getElementById('auth-email').value.trim();
        if (!email) {
            return showToast("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶ü‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");
        }
        try {
            await auth.sendPasswordResetEmail(email);
            showToast("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! üìß");
        } catch (err) {
            let msg = err.message;
            if(err.code === 'auth/user-not-found') msg = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!";
            if(err.code === 'auth/invalid-email') msg = "‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏ ‡¶¶‡¶ø‡¶®!";
            showToast(msg);
        }
    }

    // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßã‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
async function processReferral(referCode, newUserId, newUserName) {
    if (!referCode) return;
    
    try {
        const token = await auth.currentUser.getIdToken();
        const response = await fetch('https://taskbajar-backend.vercel.app/api/referral', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                referCode: referCode,
                newUserName: newUserName
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log("Referral bonus processed successfully securely!");
        }
    } catch (error) {
        console.error("Error processing referral: ", error);
    }
}


    async function handleAuthAction() {
        const e = document.getElementById('auth-email').value.trim();
        const p = document.getElementById('auth-password').value.trim();
        if (!e || p.length < 6) return showToast("Email & 6-char password required!");
        
        try {
            if (isSignupMode) {
                const n = document.getElementById('reg-name').value.trim();
                const rCode = document.getElementById('reg-refer').value.trim(); // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶®‡ßá‡¶ì‡ßü‡¶æ
                
                if (!n) return showToast("Name required!");
                const res = await auth.createUserWithEmailAndPassword(e, p);
                await res.user.sendEmailVerification();
                
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø
                await db.ref(`artifacts/${appId}/users/${res.user.uid}/stats`).set({
                    name: n, 
                    points: 50, // ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏
                    referralCode: res.user.uid.substring(0, 6).toUpperCase(), 
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });

                // ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                if (rCode) {
                    await processReferral(rCode, res.user.uid, n);
                }

                showToast("Verification email sent!");
                document.getElementById('auth-view').classList.remove('active');
                document.getElementById('verify-view').classList.add('active');
            } else { 
                await auth.signInWithEmailAndPassword(e, p);
                // logic handled by onAuthStateChanged
            }
        } catch (err) { 
            let errorMsg = err.message;
            if(err.code === 'auth/wrong-password') errorMsg = "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!";
            if(err.code === 'auth/user-not-found') errorMsg = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á!";
            if(err.code === 'auth/email-already-in-use') errorMsg = "‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶ó‡ßá‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!";
            showToast(errorMsg); 
        }
    }

    async function reloadUser() {
        const user = auth.currentUser;
        if (user) {
            await user.reload();
            if (user.emailVerified) { window.location.href = 'index.html'; } 
            else { showToast("Please verify email first."); }
        }
    }

    async function resendVerification() {
        const user = auth.currentUser;
        if (user) {
            try { await user.sendEmailVerification(); showToast("Verification email resent!"); } 
            catch (err) { showToast(err.message); }
        }
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            if (user.emailVerified) {
                window.location.href = 'index.html';
            } else {
                document.getElementById('auth-view').classList.remove('active');
                document.getElementById('verify-view').classList.add('active');
            }
        }
    });
</script>
</body>
</html>


