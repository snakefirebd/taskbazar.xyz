<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Bazar - Earn & Promote</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --p-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --p-glow: 0 0 20px rgba(99, 102, 241, 0.4);
            --bg: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --text-h: #0f172a;
            --text-p: #64748b;
            --accent: #10b981;
            --danger: #f43f5e;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-h); line-height: 1.6; padding-bottom: 90px; overflow-x: hidden; }

        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .header {
            background: var(--p-gradient); color: white; padding: 12px 15px 25px;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.15);
            display: none;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto; gap: 8px; }

        .avatar-frame {
            width: 36px; height: 36px; border-radius: 12px;
            background: rgba(255,255,255,0.2); border: 1.5px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px); overflow: hidden; display: flex; justify-content: center; align-items: center; flex-shrink: 0; cursor: pointer;
        }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .header-lang-switch {
            display: flex; background: rgba(0,0,0,0.1); padding: 3px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15);
        }
        .h-lang-btn {
            padding: 4px 8px; font-size: 0.55rem; font-weight: 800; border-radius: 8px; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.6);
        }
        .h-lang-btn.active { background: white; color: #6366f1; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .wallet-pill {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); padding: 5px 10px;
            border-radius: 14px; border: 1px solid rgba(255,255,255,0.25); text-align: right; flex-shrink: 0;
        }
        .wallet-pill span { font-size: 0.45rem; text-transform: uppercase; font-weight: 800; opacity: 0.8; display: block; line-height: 1; }
        .wallet-pill b { display: block; font-size: 0.95rem; font-weight: 800; line-height: 1.2; }

        .notif-btn { position: relative; background: rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; cursor: pointer; }
        .notif-badge { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid white; display: none; }

        .container { padding: 0 18px; margin-top: -8px; max-width: 480px; margin-left: auto; margin-right: auto; }
        .view { display: none; animation: viewIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes viewIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .elite-card {
            background: var(--glass); backdrop-filter: blur(20px); border-radius: 22px; padding: 18px;
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.7);
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            transition: 0.3s;
        }
        .section-h { font-size: 1rem; font-weight: 800; margin: 15px 0 10px 5px; color: #1e293b; }

        .btn-elite {
            width: 100%; padding: 14px; border: none; border-radius: 16px;
            background: var(--p-gradient); color: white; font-size: 0.9rem; font-weight: 700;
            cursor: pointer; transition: 0.3s; box-shadow: var(--p-glow);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-elite:active { transform: scale(0.97); }
        .btn-ghost { background: #f1f5f9; color: var(--text-p); box-shadow: none; margin-top: 10px; }

        /* ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .nav-bar-container {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            z-index: 1000; display: none; flex-direction: column; gap: 10px;
        }
        .expanded-menu {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 20px; padding: 12px; display: flex; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #fff;
            opacity: 0; transform: translateY(20px); pointer-events: none;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nav-bar-container.open .expanded-menu { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .nav-bar {
            height: 65px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-radius: 20px; display: flex; align-items: center; justify-content: space-around;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid #fff;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; cursor: pointer; text-decoration: none; transition: 0.3s; }
        .nav-item.active { color: #6366f1; transform: translateY(-2px); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 1px; font-style: normal; }
        .nav-item span { font-size: 0.5rem; font-weight: 700; white-space: nowrap; }

        .input-group { margin-bottom: 14px; }
        .input-group label { display: block; font-size: 0.7rem; font-weight: 800; color: var(--text-p); margin-bottom: 5px; margin-left: 5px; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px 18px; background: #f8fafc; border: 1px solid #e2e8f0;
            border-radius: 15px; outline: none; transition: 0.3s; font-size: 0.9rem;
        }

        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 0.75rem; font-weight: 600; display: none; z-index: 3000; box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .chat-container { height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 5px; }
        .bubble { padding: 10px 14px; border-radius: 15px; font-size: 0.8rem; max-width: 80%; font-weight: 500; }
        .bubble-me { background: var(--p-gradient); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-admin { background: #f1f5f9; color: var(--text-h); align-self: flex-start; border-bottom-left-radius: 4px; }

        .notif-card { background: white; padding: 15px; border-radius: 18px; margin-bottom: 12px; border-left: 5px solid #6366f1; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .notif-card h4 { font-size: 0.85rem; font-weight: 800; color: #1e293b; }
        .notif-card p { font-size: 0.75rem; color: #64748b; margin-top: 5px; }
        .notif-card small { font-size: 0.6rem; color: #94a3b8; display: block; margin-top: 8px; font-weight: 700; }
        .status-open { background: #fef3c7; color: #92400e; }
        .status-solved { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div id="toast">Message</div>

<!-- Auth Popup Overlay (Guest Mode) -->
<div id="auth-popup-overlay" style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center;">
    <div class="elite-card" style="width: 90%; max-width: 360px; text-align: center; animation: viewIn 0.3s ease-out; background: white; padding: 30px 20px;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üëã</div>
        <h3 style="font-weight: 800; font-size: 1.3rem; color: #0f172a; margin-bottom: 8px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®!</h3>
        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 25px;">‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ü‡ßü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        <button class="btn-elite" onclick="location.href='login.html'">‡¶≤‡¶ó‡¶á‡¶® / ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™</button>
        <button class="btn-elite btn-ghost" onclick="hideAuthPopup()">‡¶™‡¶∞‡ßá ‡¶ï‡¶∞‡¶¨</button>
    </div>
</div>

<div id="app-content" style="display: none;">
    <!-- ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div class="avatar-frame" onclick="location.href='profile.html'">
                    <img id="top-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
                </div>
                <div>
                    <h2 id="user-display-name" style="font-size: 0.75rem; font-weight: 800;">Elite Member</h2>
                    <span style="font-size: 0.45rem; font-weight: 800; background: rgba(255,255,255,0.2); padding: 1px 4px; border-radius: 6px;">PRO</span>
                </div>
            </div>

            <div style="display:flex; align-items:center; gap:8px;">
                <div class="notif-btn" onclick="openNotifications()">
                    üîî <div id="notif-badge" class="notif-badge"></div>
                </div>
                <div class="header-lang-switch">
                    <div id="h-btn-bn" class="h-lang-btn" onclick="setLang('bn')">BN</div>
                    <div id="h-btn-en" class="h-lang-btn" onclick="setLang('en')">EN</div>
                </div>
                <div class="wallet-pill"><span data-i18n="points">Points</span><b id="user-points">0</b></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="list-view" class="view active">
            <div id="notice-board" style="background:#fff7ed; border:1px solid #ffedd5; padding:10px; border-radius:15px; margin-top:20px; color:#9a3412; font-size: 0.75rem; font-weight:700; display:none;">
                <marquee id="notice-text"></marquee>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px;">
                <div class="elite-card" style="padding: 15px; text-align: center; cursor: pointer; margin-bottom:0;" onclick="showView('spin-view')">
                    <div style="font-size: 1.5rem; margin-bottom: 3px;">üé°</div>
                    <p data-i18n="spin" style="font-size: 0.65rem; font-weight: 800; color: #6366f1;">Lucky Spin</p>
                </div>
                <div class="elite-card" style="padding: 15px; text-align: center; cursor: pointer; margin-bottom:0;" onclick="claimDailyBonus()">
                    <div style="font-size: 1.5rem; margin-bottom: 3px;">üéÅ</div>
                    <p data-i18n="gift" style="font-size: 0.65rem; font-weight: 800; color: #10b981;">Daily Gift</p>
                </div>
            </div>
            <h3 data-i18n="missions" class="section-h">Available Missions</h3>
            <div id="task-container"></div>
        </div>

        <div id="notification-view" class="view">
            <h3 class="section-h" data-i18n="notifTitle">System Notifications</h3>
            <div id="notif-list" style="margin-top:10px;"></div>
            <button class="btn-elite btn-ghost" onclick="showView('list-view')" style="margin-top:15px;" data-i18n="backBtn">‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>

        <div id="support-view" class="view">
            <h3 data-i18n="support" class="section-h">Support Chat</h3>
            <div class="elite-card">
                <div id="chat-box" class="chat-container"></div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <input type="text" id="chat-input" placeholder="Message..." style="flex:1; padding:12px 15px; border-radius:12px; border:1px solid #e2e8f0; outline:none; font-size:0.85rem;">
                    <button class="btn-elite" onclick="sendMessage()" style="width: 45px; padding:0; height: 45px;">‚û§</button>
                </div>
            </div>
        </div>

        <div id="detail-view" class="view">
            <div class="elite-card" style="margin-top: 30px;">
                <div id="detail-content"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                    <div class="input-group">
                        <label data-i18n="proofLabel">Submission Proof (Username/Link)</label>
                        <textarea id="task-proof" rows="2" placeholder="‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®"></textarea>
                    </div>
                    <button data-i18n="submitBtn" class="btn-elite" onclick="submitProof()">Submit Proof</button>
                    <button data-i18n="cancelBtn" class="btn-elite btn-ghost" onclick="showView('list-view')">Cancel</button>
                </div>
            </div>
        </div>

        <div id="spin-view" class="view">
            <h3 data-i18n="spin" class="section-h">Fortune Wheel</h3>
            <div class="elite-card" style="text-align: center; padding: 30px 20px; position: relative;">
                <div style="position: relative; width: 260px; height: 260px; margin: 0 auto 30px; display: flex; justify-content: center; align-items: center;">
                    <div id="wheel-canvas-container" style="width: 100%; height: 100%; border-radius: 50%; border: 8px solid #f1f5f9; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; transition: transform 4s cubic-bezier(0.1, 0, 0, 1);">
                        <canvas id="wheel-canvas" width="260" height="260"></canvas>
                    </div>
                    <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #6366f1; z-index: 10;"></div>
                    <div style="position: absolute; width: 40px; height: 40px; background: white; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 5; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #6366f1; border: 3px solid #6366f1;">WIN</div>
                </div>
                <button class="btn-elite" id="spin-btn" onclick="enhancedSpinWheel()">Spin for 5 Points</button>
                <button data-i18n="backBtn" class="btn-elite btn-ghost" onclick="showView('list-view')">Back to Tasks</button>
            </div>
        </div>
    </div>

    <!-- ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ (‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞) ‡¶∏‡ßá‡¶ï‡¶∂‡¶® -->
    <div class="nav-bar-container" id="navContainer">
        <div class="expanded-menu">
            <a href="leaderboard.html" class="nav-item">
                <i style="background: #fdf2f8; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px;">üèÜ</i>
                <span style="font-size: 0.6rem;">Leaderboard</span>
            </a>
            
            <a href="complaint.html" class="nav-item">
                <i style="background: #f1f5f9; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px;">üõ†Ô∏è</i>
                <span style="font-size: 0.6rem;">Support</span>
            </a>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="showView('list-view'); updateNav(this)"><i>üè†</i><span data-i18n="navMissions">Missions</span></div>
            <div class="nav-item" onclick="location.href='order.html'"><i>üöÄ</i><span data-i18n="navPromote">Promote</span></div>
            <div class="nav-item" onclick="location.href='profile.html'"><i>üë§</i><span data-i18n="navProfile">Profile</span></div>
            <div class="nav-item" onclick="toggleMenu()">
                <i id="menuIcon" style="transition: 0.3s; font-style: normal; font-size: 1.3rem;">+</i>
                <span>Menu</span>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDgFaTrHW7Grp_Q22p6KNcHZxaEujHsLsE",
        authDomain: "exchange-project-d4028.firebaseapp.com",
        databaseURL: "https://exchange-project-d4028-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "exchange-project-d4028",
        storageBucket: "exchange-project-d4028.firebasestorage.app",
        messagingSenderId: "313976742479",
        appId: "1:313976742479:web:45951b360d875c4768c03a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const appId = "exchange-project-d4028";

    let currentUserId = null;
    let userPoints = 0;
    let selectedTaskId = null;
    let currentLang = localStorage.getItem('elite_lang') || 'bn';
    let authPopupTimer = null;

    const translations = {
        bn: {
            authTagline: "‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã-‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ",
            fullName: "‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ", referCode: "‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)", email: "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏", password: "‡¶ó‡ßã‡¶™‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°",
            points: "‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü", spin: "‡¶≤‡¶æ‡¶ï‡¶ø ‡¶∏‡ßç‡¶™‡¶ø‡¶®", gift: "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶â‡¶™‡¶π‡¶æ‡¶∞", missions: "‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶Æ‡¶ø‡¶∂‡¶®",
            directChatText: "‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá:", adminSupportBtn: "‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü)",
            pageHome: "‡¶π‡ßã‡¶Æ / ‡¶Æ‡¶ø‡¶∂‡¶®", pagePromote: "‡¶™‡ßç‡¶∞‡¶Æ‡ßã‡¶ü ‡¶™‡ßá‡¶ú", pageProfile: "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßá‡¶ú", pageSpin: "‡¶∏‡ßç‡¶™‡¶ø‡¶® / ‡¶¨‡ßã‡¶®‡¶æ‡¶∏", pagePayment: "‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ",
            navMissions: "‡¶Æ‡¶ø‡¶∂‡¶®", navPromote: "‡¶™‡ßç‡¶∞‡¶Æ‡ßã‡¶ü", navChat: "‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó", navProfile: "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤",
            adminReply: "‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞:", statusPending: "‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç", statusSolved: "‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá", logout: "‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü",
            performTask: "‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® üîó", missionReward: "‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°:", proofLabel: "‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£ (‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ/‡¶≤‡¶ø‡¶ô‡ßç‡¶ï)", submitBtn: "‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®", cancelBtn: "‡¶¨‡¶æ‡¶§‡¶ø‡¶≤", backBtn: "‡¶™‡¶ø‡¶õ‡¶®‡ßá ‡¶Ø‡¶æ‡¶®",
            verifyEmailTitle: "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®", verifyEmailMsg: "‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá‡¶õ‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶®‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
            checkVerifyBtn: "‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®", resendLinkBtn: "‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶™‡¶æ‡¶†‡¶æ‡¶®",
            notifTitle: "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®", noNotif: "‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á"
        },
        en: {
            authTagline: "The Premium Micro-Task Platform",
            fullName: "Full Name", referCode: "Refer Code (Optional)", email: "Email Address", password: "Secret Password",
            points: "Points", spin: "Lucky Spin", gift: "Daily Gift", missions: "Available Missions",
            directChatText: "To talk directly with Admin:", adminSupportBtn: "Admin Support (Chat)",
            pageHome: "Home / Missions", pagePromote: "Promote Page", pageProfile: "Profile Page", pageSpin: "Spin / Bonus", pagePayment: "Payment Issue",
            navMissions: "Missions", navPromote: "Promote", navChat: "Complaint", navProfile: "Profile",
            adminReply: "Admin Reply:", statusPending: "Pending", statusSolved: "Solved", logout: "Logout",
            performTask: "Perform Task üîó", missionReward: "Mission Reward:", proofLabel: "Proof (Username/Link)", submitBtn: "Submit", cancelBtn: "Cancel", backBtn: "Back",
            verifyEmailTitle: "Verify Your Email", verifyEmailMsg: "We've sent a verification link to your email. Please check your inbox.",
            checkVerifyBtn: "Check Verification Status", resendLinkBtn: "Resend Link",
            notifTitle: "System Notifications", noNotif: "No notifications found"
        }
    };

    function showToast(msg) { 
        const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; 
        setTimeout(() => t.style.display = 'none', 3000); 
    }

    // Toggle Menu Logic
    function toggleMenu() {
        const container = document.getElementById('navContainer');
        const icon = document.getElementById('menuIcon');
        container.classList.toggle('open');
        icon.style.transform = container.classList.contains('open') ? 'rotate(45deg)' : 'rotate(0deg)';
    }

    document.addEventListener('click', (e) => {
        const container = document.getElementById('navContainer');
        if (container && !container.contains(e.target) && container.classList.contains('open')) toggleMenu();
    });

    // Popup functions
    function showAuthPopup() {
        document.getElementById('auth-popup-overlay').style.display = 'flex';
    }

    function hideAuthPopup() {
        document.getElementById('auth-popup-overlay').style.display = 'none';
        clearTimeout(authPopupTimer);
        authPopupTimer = setTimeout(showAuthPopup, 15000);
    }

    function requireAuth() {
        if (!currentUserId) {
            showAuthPopup();
            return false;
        }
        return true;
    }

    function showView(id) { 
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
        const view = document.getElementById(id);
        if(view) view.classList.add('active');
        if(id === 'spin-view') drawWheel();
        localStorage.setItem('last_view', id);
    }

    function updateNav(el) { 
        document.querySelectorAll('.nav-bar .nav-item').forEach(i => i.classList.remove('active')); 
        if(el) el.classList.add('active'); 
    }

    function setLang(lang) {
        currentLang = lang;
        localStorage.setItem('elite_lang', lang);
        applyTranslations();
        document.querySelectorAll('.h-lang-btn').forEach(b => b.classList.remove('active'));
        if(document.getElementById(`h-btn-${lang}`)) document.getElementById(`h-btn-${lang}`).classList.add('active');
    }

    function applyTranslations() {
        const t = translations[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerText = t[key];
        });
    }

    function checkAuthState(user) {
        const appContent = document.getElementById('app-content');
        const header = document.querySelector('.header');
        const navBarContainer = document.querySelector('.nav-bar-container');

        // Show layout for both logged in and guest users
        appContent.style.display = 'block';
        header.style.display = 'block';
        navBarContainer.style.display = 'flex';
        
        const lastView = localStorage.getItem('last_view') || 'list-view';
        showView(lastView);
        loadSystemNotice(); 
        loadAllTasks();

        if (user && user.emailVerified) {
            localStorage.setItem('isLoggedIn', 'true');
            currentUserId = user.uid;
            
            syncUserData(); 
            initNotificationListener();

            document.getElementById('auth-popup-overlay').style.display = 'none';
            clearTimeout(authPopupTimer);
        } else {
            localStorage.removeItem('isLoggedIn');
            currentUserId = null;
            document.getElementById('user-display-name').innerText = "Guest User";
            document.getElementById('user-points').innerText = "0";
            
            showAuthPopup();
        }
    }

    function syncUserData() {
        db.ref(`artifacts/${appId}/users/${currentUserId}/stats`).on('value', snap => {
            const d = snap.val() || {};
            localStorage.setItem('user_cache_data', JSON.stringify(d));
            updateUI(d);
        });
    }

    function updateUI(d) {
        userPoints = d.points || 0;
        document.getElementById('user-points').innerText = userPoints;
        document.getElementById('user-display-name').innerText = d.name || "User";
        
        const avatarImg = document.getElementById('top-avatar');
        if(d.avatar && d.avatar !== "" && d.avatar !== "null" && d.avatar !== "undefined") {
            avatarImg.src = d.avatar;
        }

        if(document.getElementById(`h-btn-${currentLang}`)) document.getElementById(`h-btn-${currentLang}`).classList.add('active');
    }

    function loadSystemNotice() {
        db.ref(`artifacts/${appId}/public/settings/notice`).on('value', s => {
            const n = s.val(); const board = document.getElementById('notice-board');
            if(n && board) { document.getElementById('notice-text').innerText = n; board.style.display = 'block'; }
        });
    }

    function initNotificationListener() {
        if(!currentUserId) return;
        const badge = document.getElementById('notif-badge');
        const container = document.getElementById('notif-list');
        const lastChecked = localStorage.getItem('last_notif_check') || 0;

        const pubRef = db.ref(`artifacts/${appId}/public/notifications`);
        const pvtRef = db.ref(`artifacts/${appId}/users/${currentUserId}/notifications`);

        const handleNotifs = () => {
            pubRef.once('value', pubSnap => {
                pvtRef.once('value', pvtSnap => {
                    const pubs = pubSnap.val() || {};
                    const pvts = pvtSnap.val() || {};
                    const combined = [];
                    Object.keys(pubs).forEach(id => combined.push({...pubs[id], id, scope: 'public'}));
                    Object.keys(pvts).forEach(id => combined.push({...pvts[id], id, scope: 'private'}));
                    combined.sort((a,b) => b.timestamp - a.timestamp);

                    if(!container) return;
                    container.innerHTML = '';
                    let hasNew = false;
                    combined.forEach(n => {
                        if(n.timestamp > lastChecked) hasNew = true;
                        const isPvt = n.scope === 'private';
                        container.innerHTML += `
                            <div class="notif-card" style="${isPvt ? 'border-left: 5px solid #f59e0b; background: #fffbeb;' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <h4 style="font-size:0.85rem; font-weight:800;">${n.title}</h4>
                                    <span style="font-size:0.5rem; padding:2px 6px; border-radius:5px; background:${isPvt ? '#fef3c7' : '#eef2ff'}; color:${isPvt ? '#92400e' : '#4338ca'}; font-weight:800; border: 1px solid rgba(0,0,0,0.05);">
                                        ${isPvt ? 'PRIVATE' : 'PUBLIC'}
                                    </span>
                                </div>
                                <p style="font-size:0.75rem; color:#64748b; margin-top:5px;">${n.message}</p>
                                <small style="font-size:0.6rem; color:#94a3b8; display:block; margin-top:8px;">${new Date(n.timestamp).toLocaleString()}</small>
                            </div>`;
                    });
                    if(combined.length === 0) container.innerHTML = `<p style="text-align:center; padding:20px; font-size:0.8rem; color:var(--text-p);">${translations[currentLang].noNotif}</p>`;
                    badge.style.display = hasNew ? 'block' : 'none';
                });
            });
        };
        pubRef.on('value', handleNotifs);
        pvtRef.on('value', handleNotifs);
    }

    function openNotifications() {
        if(!requireAuth()) return;
        localStorage.setItem('last_notif_check', Date.now());
        document.getElementById('notif-badge').style.display = 'none';
        showView('notification-view');
    }

    function loadAllTasks() {
        db.ref(`artifacts/${appId}/public/data/microtasks`).on('value', taskSnap => {
            const tasks = taskSnap.val() || {};
            db.ref(`artifacts/${appId}/public/data/submissions`).on('value', subSnap => {
                const subs = subSnap.val() || {};
                const container = document.getElementById('task-container');
                if(!container) return; container.innerHTML = '';
                Object.keys(tasks).reverse().forEach(id => {
                    const item = tasks[id];
                    if (currentUserId && item.creatorId === currentUserId) return;
                    let mySubStatus = null;
                    if(currentUserId && subs[id]) {
                        Object.keys(subs[id]).forEach(sId => {
                            if(subs[id][sId].userId === currentUserId) mySubStatus = subs[id][sId].status;
                        });
                    }
                    if (mySubStatus === 'approved' || mySubStatus === 'rejected') return;
                    const isPending = mySubStatus === 'pending';
                    const t = translations[currentLang];
                    container.innerHTML += `
                        <div class="elite-card ${isPending ? 'pending-task' : ''}" 
                             onclick="${isPending ? '' : `openTaskDetails('${id}')`}" 
                             style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4 style="font-size:0.85rem; font-weight:800;">${item.title}</h4>
                                <p style="color:#10b981; font-weight:800; font-size:0.75rem;">+${item.reward} ${t.points}</p>
                            </div>
                            <div style="background:#f1f5f9; width:30px; height:30px; border-radius:10px; display:flex; align-items:center; justify-content:center;">
                                ${isPending ? 'üîí' : '‚Üí'}
                            </div>
                        </div>`;
                });
            });
        });
    }

    async function openTaskDetails(id) {
        if(!requireAuth()) return;
        const snap = await db.ref(`artifacts/${appId}/public/data/microtasks/${id}`).once('value');
        const t = snap.val(); selectedTaskId = id;
        const trans = translations[currentLang];
        document.getElementById('detail-content').innerHTML = `
            <h3 style="font-weight:800; margin-bottom:8px; font-size:1rem;">${t.title}</h3>
            <span style="background:#f0fdf4; color:#10b981; font-weight:800; padding:4px 10px; border-radius:8px; font-size:0.7rem;">${trans.missionReward} ${t.reward}</span>
            <p style="font-size:0.75rem; color:#64748b; margin:15px 0;">‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶ø‡¶∂‡¶®‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <a href="${t.link}" target="_blank" class="btn-elite" style="display:block; text-align:center; text-decoration:none; margin-bottom:12px; background:#f1f5f9; color:#6366f1; box-shadow:none;">${trans.performTask}</a>
        `;
        showView('detail-view');
    }

    async function submitProof() {
        if(!requireAuth()) return;
        const proof = document.getElementById('task-proof').value.trim();
        if(!proof) return showToast("Proof required!");
        await db.ref(`artifacts/${appId}/public/data/submissions/${selectedTaskId}/${Date.now()}`).set({
            userId: currentUserId, proof, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        document.getElementById('task-proof').value = '';
        showToast("Submitted!"); showView('list-view');
    }

    async function claimDailyBonus() {
        if(!requireAuth()) return;
        const ref = db.ref(`artifacts/${appId}/users/${currentUserId}/stats`);
        const snap = await ref.once('value'); const now = new Date().setHours(0,0,0,0);
        if (snap.val().lastBonusDate === now) return showToast("Already claimed today!");
        await ref.update({ points: userPoints + 10, lastBonusDate: now });
        showToast("Claimed 10 points!");
    }

    function initChat() {
        if(!requireAuth()) return;
        db.ref(`artifacts/${appId}/support/${currentUserId}/messages`).on('value', snap => {
            const box = document.getElementById('chat-box'); box.innerHTML = '';
            const msgs = snap.val() || {};
            Object.keys(msgs).forEach(k => {
                const m = msgs[k]; const d = document.createElement('div');
                d.className = `bubble ${m.role === 'admin' ? 'bubble-admin' : 'bubble-me'}`; d.innerText = m.text;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    async function sendMessage() {
        if(!requireAuth()) return;
        const inp = document.getElementById('chat-input'); const text = inp.value.trim(); if(!text) return;
        await db.ref(`artifacts/${appId}/support/${currentUserId}/messages/${Date.now()}`).set({ text, role: 'user', timestamp: firebase.database.ServerValue.TIMESTAMP });
        await db.ref(`artifacts/${appId}/support_list/${currentUserId}`).set({ lastMsg: text, name: document.getElementById('user-display-name').innerText, timestamp: firebase.database.ServerValue.TIMESTAMP });
        inp.value = '';
    }

    const prizes = [{ label: "0", color: "#f43f5e" },{ label: "2", color: "#6366f1" },{ label: "5", color: "#10b981" },{ label: "10", color: "#f59e0b" },{ label: "20", color: "#a855f7" },{ label: "0", color: "#64748b" },{ label: "50", color: "#ec4899" },{ label: "5", color: "#06b6d4" }];

    function drawWheel() {
        const canvas = document.getElementById('wheel-canvas'); if (!canvas) return;
        const ctx = canvas.getContext('2d'); const centerX = canvas.width / 2; const centerY = canvas.height / 2;
        const radius = canvas.width / 2; const sliceAngle = (2 * Math.PI) / prizes.length;
        prizes.forEach((prize, i) => {
            const angle = i * sliceAngle; ctx.beginPath(); ctx.fillStyle = prize.color;
            ctx.moveTo(centerX, centerY); ctx.arc(centerX, centerY, radius, angle, angle + sliceAngle); ctx.fill();
            ctx.save(); ctx.translate(centerX, centerY); ctx.rotate(angle + sliceAngle / 2); ctx.textAlign = "right"; ctx.fillStyle = "white"; ctx.font = "bold 16px sans-serif"; ctx.fillText(prize.label, radius - 20, 5); ctx.restore();
        });
    }

let isSpinning = false;
async function enhancedSpinWheel() {
    if(!requireAuth()) return;
    if (isSpinning) return;
    if (userPoints < 5) return showToast("Low points! Need at least 5 points.");

    isSpinning = true;
    const btn = document.getElementById('spin-btn');
    btn.disabled = true;

    try {
        // ‡ßß. ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶®‡ßá‡¶ì‡ßü‡¶æ
        const token = await auth.currentUser.getIdToken();

        // ‡ß®. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶°‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã (‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶≠‡ßÅ‡¶≤‡¶¨‡ßá‡¶® ‡¶®‡¶æ)
        const response = await fetch('https://taskbajar-backend.vercel.app/api/spin', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || "Server Error!");
            isSpinning = false;
            btn.disabled = false;
            return;
        }

        // ‡ß©. ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ prizeIndex ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ö‡¶æ‡¶ï‡¶æ ‡¶ò‡ßã‡¶∞‡¶æ‡¶®‡ßã
        const wheel = document.getElementById('wheel-canvas-container');
        const sliceSize = 360 / prizes.length;
        
        // prizeIndex ‡¶è‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶è‡¶ô‡ßç‡¶ó‡ßá‡¶≤ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
        const targetRotation = 270 - (data.prizeIndex * sliceSize) - (sliceSize / 2);
        const randomSpins = 360 * 5; // ‡ß´ ‡¶¨‡¶æ‡¶∞ ‡¶ò‡ßÅ‡¶∞‡¶¨‡ßá
        const totalSpin = randomSpins + targetRotation;

        wheel.style.transform = `rotate(${totalSpin}deg)`;

        setTimeout(() => {
            showToast(data.winAmount > 0 ? `Won ${data.winAmount} Points!` : "Try again.");
            // ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï UI ‡¶§‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
            isSpinning = false;
            btn.disabled = false;

            // ‡¶ö‡¶æ‡¶ï‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            const netRotation = totalSpin % 360;
            wheel.style.transition = 'none';
            wheel.style.transform = `rotate(${netRotation}deg)`;
            setTimeout(() => { wheel.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0, 1)'; }, 50);
        }, 4000);

    } catch (error) {
        showToast("Network Error!");
        isSpinning = false;
        btn.disabled = false;
    }
}


    auth.onAuthStateChanged(checkAuthState);
    applyTranslations();
</script>
</body>
</html>


